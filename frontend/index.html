<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Terraforming Mars - Scoreboard</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- Socket.IO Client - 로컬 파일 우선, CDN 대체 -->
    <script>
        // Socket.IO 로딩 시도
        (function() {
            // 1. 로컬 파일 시도
            var localScript = document.createElement('script');
            localScript.src = 'socket.io.min.js';
            localScript.onerror = function() {
                console.log('Local Socket.IO not found, trying CDN...');
                // 2. CDN 시도
                var cdnScript = document.createElement('script');
                cdnScript.src = 'https://cdn.jsdelivr.net/npm/socket.io-client@4.7.2/dist/socket.io.min.js';
                cdnScript.onerror = function() {
                    console.log('Primary CDN failed, trying backup...');
                    // 3. 백업 CDN 시도
                    var backupScript = document.createElement('script');
                    backupScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js';
                    backupScript.onerror = function() {
                        console.error('All Socket.IO sources failed!');
                    };
                    document.head.appendChild(backupScript);
                };
                document.head.appendChild(cdnScript);
            };
            document.head.appendChild(localScript);
        })();
    </script>
    <div id="app">
        <!-- 계산기 모달 -->
        <calculator-modal
            :show="showCalculator"
            :resource="calculatorData.resource"
            :current-value="calculatorData.currentValue"
            @close="closeCalculator"
            @spend="handleSpend"
            @gain="handleGain"
        ></calculator-modal>

        <!-- 게임 설정 -->
        <div class="game-settings">
            <button @click="resetGame">New Game</button>
            <label>
                View:
                <select v-model="viewMode">
                    <option value="all">All Players</option>
                    <option value="player1">Player 1</option>
                    <option value="player2">Player 2</option>
                    <option value="player3">Player 3</option>
                </select>
            </label>
            <div class="generation-control">
                <label>Generation: <span class="generation-value">{{ currentGeneration }}</span></label>
                <button class="next-generation-btn" @click="nextGeneration">→</button>
            </div>
        </div>

        <!-- 게임 보드 -->
        <div class="game-container" :class="{ 'single-player': viewMode !== 'all', 'two-players': viewMode === 'all' && playerCount === 2, 'three-players': viewMode === 'all' && playerCount === 3 }">
            <!-- Player 1 -->
            <div class="player-board" v-if="viewMode === 'all' || viewMode === 'player1'">
                <div class="player-board-header">
                    <h2>
                        <span v-if="editingPlayerName !== 'player1'"
                              class="player-name"
                              @click="startEditingPlayerName('player1')">
                            {{ gameState.player1.name }}
                        </span>
                        <input v-else
                               v-model="editingNameValue"
                               @keyup.enter="savePlayerName('player1')"
                               @keyup.esc="cancelEditingPlayerName"
                               @blur="savePlayerName('player1')"
                               class="player-name-input"
                               autofocus>
                    </h2>
                    <div class="terraforming-rating">
                        <label>TR</label>
                        <div class="counter">
                            <button @click="updateRating('player1', -1)">−</button>
                            <span class="value">{{ gameState.player1.terraformingRating }}</span>
                            <button @click="updateRating('player1', 1)">+</button>
                        </div>
                    </div>
                    <button
                        class="undo-button"
                        @click="undoPlayerAction('player1')"
                        :disabled="playerHistory.player1.length === 0"
                        title="Undo last action">
                        ↺
                    </button>
                </div>

                <!-- 리소스 카드 -->
                <div class="resources-grid">
                    <resource-card
                        v-for="resource in resources"
                        :key="resource.type"
                        :resource="resource"
                        :player-data="gameState.player1[resource.type]"
                        :player-id="'player1'"
                        @update="updateResource('player1', resource.type, $event)"
                        @open-calculator="openCalculator"
                    ></resource-card>
                </div>
            </div>

            <!-- Player 2 -->
            <div class="player-board" v-if="viewMode === 'all' || viewMode === 'player2'">
                <div class="player-board-header">
                    <h2>
                        <span v-if="editingPlayerName !== 'player2'"
                              class="player-name"
                              @click="startEditingPlayerName('player2')">
                            {{ gameState.player2.name }}
                        </span>
                        <input v-else
                               v-model="editingNameValue"
                               @keyup.enter="savePlayerName('player2')"
                               @keyup.esc="cancelEditingPlayerName"
                               @blur="savePlayerName('player2')"
                               class="player-name-input"
                               autofocus>
                    </h2>
                    <div class="terraforming-rating">
                        <label>TR</label>
                        <div class="counter">
                            <button @click="updateRating('player2', -1)">−</button>
                            <span class="value">{{ gameState.player2.terraformingRating }}</span>
                            <button @click="updateRating('player2', 1)">+</button>
                        </div>
                    </div>
                    <button
                        class="undo-button"
                        @click="undoPlayerAction('player2')"
                        :disabled="playerHistory.player2.length === 0"
                        title="Undo last action">
                        ↺
                    </button>
                </div>

                <!-- 리소스 카드 -->
                <div class="resources-grid">
                    <resource-card
                        v-for="resource in resources"
                        :key="resource.type"
                        :resource="resource"
                        :player-data="gameState.player2[resource.type]"
                        :player-id="'player2'"
                        @update="updateResource('player2', resource.type, $event)"
                        @open-calculator="openCalculator"
                    ></resource-card>
                </div>
            </div>

            <!-- Player 3 -->
            <div class="player-board" v-if="viewMode === 'all' || viewMode === 'player3'">
                <div class="player-board-header">
                    <h2>
                        <span v-if="editingPlayerName !== 'player3'"
                              class="player-name"
                              @click="startEditingPlayerName('player3')">
                            {{ gameState.player3.name }}
                        </span>
                        <input v-else
                               v-model="editingNameValue"
                               @keyup.enter="savePlayerName('player3')"
                               @keyup.esc="cancelEditingPlayerName"
                               @blur="savePlayerName('player3')"
                               class="player-name-input"
                               autofocus>
                    </h2>
                    <div class="terraforming-rating">
                        <label>TR</label>
                        <div class="counter">
                            <button @click="updateRating('player3', -1)">−</button>
                            <span class="value">{{ gameState.player3.terraformingRating }}</span>
                            <button @click="updateRating('player3', 1)">+</button>
                        </div>
                    </div>
                    <button
                        class="undo-button"
                        @click="undoPlayerAction('player3')"
                        :disabled="playerHistory.player3.length === 0"
                        title="Undo last action">
                        ↺
                    </button>
                </div>

                <!-- 리소스 카드 -->
                <div class="resources-grid">
                    <resource-card
                        v-for="resource in resources"
                        :key="resource.type"
                        :resource="resource"
                        :player-data="gameState.player3[resource.type]"
                        :player-id="'player3'"
                        @update="updateResource('player3', resource.type, $event)"
                        @open-calculator="openCalculator"
                    ></resource-card>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.js"></script>
    <script src="main.js"></script>
</body>
</html>
